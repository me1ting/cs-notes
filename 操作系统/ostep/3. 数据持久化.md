# I/O设备

在并发部分中，我们看到I/O操作是使用并发的关键因素，I/O操作存在着随机性。学习I/O设备的工作原理，能加深我们对并发的理解，也为我们了解数据持久化做铺垫。

## 硬件系统架构

CPU通过分层的总线连接设备：

- 内存总线：内存
- PIC总线：显卡
- 外设总线：SATA,SCSI,USB...

![](assets/Pasted%20image%2020230628124939.png)

## 标准I/O设备

这里，我们学习的是一个简化的I/O设备抽象，它缺乏具体设备的实现细节，但能帮助我们大致理解I/O设备的工作原理。

![](assets/Pasted%20image%2020230628124956.png)

I/O设备内部是一个小型的计算机系统，并对外提供一个接口，由操作系统通过协议进行访问。

## 协议

使用协议来访问总线上的设备。

### 最简单的协议：轮询

操作系统可以轮询I/O设备的状态，直到状态就绪，然后执行操作：

```
While (STATUS == BUSY)
; // 轮询直到设备不再繁忙
Write data to DATA register //写入数据到寄存器
Write command to COMMAND register//写入命令到寄存器
(这样做会启动设备并执行命令)
While (STATUS == BUSY)
; // 轮询直到命令执行完成
```

其中，CPU参与数据的移动过程，称为编程的I/O(programmed IO, PIO)。

>书中描述有点混乱，一会将PIO用于描述数据移动过程，一会将PIO用于描述轮询加上数据移动过程这两部分总和。这里未作考证，使用第一种。

轮询使得CPU”空转“，PIO使得CPU”资源错配“，都是可以被优化的。

### 使用中断避免轮询

当设备完成了自身操作，可以抛出一个硬件中断，引发 CPU 跳转执行操作系统预先定义好的`中断服务例程`（Interrupt Service Routine，ISR），或更为简单的`中断处理程序`（interrupt handler）。

### 使用DMA实现异步数据传输

DMA是硬件上额外的控制设备，它能够协调完成内存和设备之间的数据传输，并在完成后通过中断通知操作系统。这样CPU就不需要参与PIO了。

## I/O指令与内存映射I/O

计算机早期阶段，使用明确的指令来访问I/O设备。

后来又发明了内存映射，将I/O设备的寄存器映射到内存地址空间，这样操作系统仅需要地址访问指令就可以访问I/O设备，背后的转换由硬件完成。

实际应用中，两者都被使用。

## 设备驱动程序

设备驱动程序是协议在特定操作系统下的封装，供操作系统的上层实现所使用。

## 小结

本章是对I/O设备概念上的学习，由于缺乏对实例的接触，终究只是处于了解水平。
